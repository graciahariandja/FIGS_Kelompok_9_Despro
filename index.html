<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FIGS - Fire Ignition Gas Sensor Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: linear-gradient(135deg, #1a0505 0%, #2d0a0a 50%, #1a0505 100%);
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(255, 69, 0, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 140, 0, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
      animation: fireGlow 8s ease-in-out infinite;
    }
    
    @keyframes fireGlow {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }
    
    .container {
      position: relative;
      z-index: 1;
      padding: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }
    
    .connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 20px;
      border-radius: 10px;
      border: 2px solid #ffa500;
      z-index: 1000;
      font-size: 0.9em;
      backdrop-filter: blur(10px);
    }
    
    .connection-status.connected {
      border-color: #32cd32;
    }
    
    .connection-status.error {
      border-color: #ff4500;
    }
    
    .landing-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      padding: 40px 20px;
    }
    
    .landing-page .group-label {
      font-size: 1.3em;
      color: #ffa500;
      margin-bottom: 10px;
      letter-spacing: 3px;
      opacity: 0.9;
    }
    
    .landing-page h1 {
      font-size: 5em;
      background: linear-gradient(135deg, #ff4500, #ffa500, #ffd700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 15px;
      font-weight: 900;
      animation: flameGlow 3s ease-in-out infinite;
    }
    
    @keyframes flameGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.3); }
    }
    
    .landing-page .system-name {
      font-size: 1.8em;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 50px;
      letter-spacing: 2px;
    }
    
    .main-menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 25px;
      margin-top: 20px;
    }
    
    .main-menu-btn {
      background: linear-gradient(135deg, #ff4500, #ff6347);
      color: white;
      border: none;
      padding: 25px 60px;
      border-radius: 15px;
      font-size: 1.3em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s ease;
      box-shadow: 0 8px 25px rgba(255, 69, 0, 0.4);
      border: 3px solid transparent;
      min-width: 400px;
    }
    
    .main-menu-btn:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 12px 40px rgba(255, 69, 0, 0.7);
      border-color: #ffd700;
      background: linear-gradient(135deg, #ff6347, #ffa500);
    }
    
    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: linear-gradient(135deg, #ff4500, #ff6347);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 69, 0, 0.4);
      z-index: 1000;
    }
    
    .back-btn:hover {
      transform: translateX(-5px);
      box-shadow: 0 6px 20px rgba(255, 69, 0, 0.6);
    }
    
    .page {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    .page.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card {
      background: rgba(20, 5, 5, 0.6);
      border-radius: 20px;
      padding: 30px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 69, 0, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      margin-bottom: 25px;
    }
    
    .card h2 {
      margin-bottom: 20px;
      font-size: 1.8em;
      background: linear-gradient(135deg, #ff6347, #ffa500);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }
    
    .page-title {
      text-align: center;
      margin: 40px 0 30px 0;
      font-size: 2.5em;
      background: linear-gradient(135deg, #ff4500, #ffa500);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
    }
    
    .about-content {
      line-height: 1.8;
    }
    
    .about-content h3 {
      color: #ffa500;
      margin-top: 25px;
      margin-bottom: 15px;
      font-size: 1.5em;
    }
    
    .about-content p {
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 15px;
    }
    
    .components-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .component-box {
      background: rgba(255, 69, 0, 0.1);
      padding: 20px;
      border-radius: 15px;
      border: 1px solid rgba(255, 140, 0, 0.3);
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .component-box:hover {
      transform: translateY(-5px);
      border-color: #ffd700;
      box-shadow: 0 8px 20px rgba(255, 140, 0, 0.3);
    }
    
    .component-box h4 {
      color: #ffa500;
      margin-bottom: 10px;
    }
    
    .tutorial-step {
      background: rgba(255, 69, 0, 0.1);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      border-left: 4px solid #ff6347;
    }
    
    .tutorial-step h3 {
      color: #ffa500;
      margin-bottom: 10px;
    }
    
    .tutorial-step p {
      color: rgba(255, 255, 255, 0.85);
      line-height: 1.6;
    }
    
    .tutorial-step code {
      background: rgba(0, 0, 0, 0.5);
      padding: 2px 8px;
      border-radius: 4px;
      color: #ffd700;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .heatmap-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    
    #grid {
      display: grid;
      grid-template-columns: repeat(8, 45px);
      grid-template-rows: repeat(8, 45px);
      gap: 4px;
      background: rgba(0, 0, 0, 0.5);
      padding: 15px;
      border-radius: 15px;
      border: 2px solid rgba(255, 69, 0, 0.3);
    }
    
    .cell {
      width: 45px;
      height: 45px;
      background: #000;
      border-radius: 6px;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .status-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .status-item {
      background: rgba(0, 0, 0, 0.4);
      padding: 20px;
      border-radius: 15px;
      border-left: 5px solid #ffa500;
      transition: all 0.3s ease;
    }
    
    .status-item.warning {
      border-left-color: #ff4500;
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 20px rgba(255, 69, 0, 0.4);
    }
    
    .status-item.safe {
      border-left-color: #32cd32;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .status-label {
      font-size: 0.95em;
      opacity: 0.8;
      margin-bottom: 8px;
      color: #ffa500;
    }
    
    .status-value {
      font-size: 1.4em;
      font-weight: bold;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .stat-box {
      background: rgba(0, 0, 0, 0.4);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      border: 1px solid rgba(255, 140, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .stat-box:hover {
      transform: scale(1.05);
      border-color: #ffd700;
    }
    
    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      background: linear-gradient(135deg, #ff6347, #ffd700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 0.9em;
      opacity: 0.8;
      color: #ffa500;
    }
    
    .legend {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0, 0, 0, 0.3);
      padding: 8px 15px;
      border-radius: 10px;
      border: 1px solid rgba(255, 140, 0, 0.2);
    }
    
    .legend-color {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border-radius: 10px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 15px 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 69, 0, 0.2);
    }
    
    th {
      background: rgba(255, 69, 0, 0.2);
      font-weight: 600;
      color: #ffa500;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    tbody tr {
      transition: all 0.2s ease;
    }
    
    tbody tr:hover {
      background: rgba(255, 69, 0, 0.1);
    }
    
    .chart-container {
      width: 100%;
      height: 300px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      border: 1px solid rgba(255, 69, 0, 0.2);
    }
    
    canvas {
      width: 100% !important;
      height: 100% !important;
    }
    
    @media (max-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      .main-menu-btn {
        min-width: 300px;
      }
      .landing-page h1 {
        font-size: 3.5em;
      }
      #grid {
        grid-template-columns: repeat(8, 38px);
        grid-template-rows: repeat(8, 38px);
      }
      .cell {
        width: 38px;
        height: 38px;
      }
    }
  </style>
</head>
<body>
  <div class="connection-status" id="connectionStatus">
    üîÑ Connecting to Firebase...
  </div>

  <div class="container">
    <!-- Landing Page -->
    <div id="landing" class="page active">
      <div class="landing-page">
        <div class="group-label">KELOMPOK 9</div>
        <h1>üî• FIGS</h1>
        <div class="system-name">Fire Ignition Gas Sensor</div>
        
        <div class="main-menu-buttons">
          <button class="main-menu-btn" onclick="showPage('about')">
            üìñ About The Project
          </button>
          <button class="main-menu-btn" onclick="showPage('tutorial')">
            üéì Tutorial Alat
          </button>
          <button class="main-menu-btn" onclick="showPage('dashboard')">
            üìä Dashboard FIGS
          </button>
        </div>
      </div>
    </div>
    
    <!-- About Page -->
    <div id="about" class="page">
      <button class="back-btn" onclick="showPage('landing')">‚Üê Back to Menu</button>
      <h1 class="page-title">About The Project</h1>
      
      <div class="card">
        <h2>üìñ Tentang FIGS</h2>
        <div class="about-content">
          <p><strong>FIGS (Fire Ignition Gas Sensor)</strong> adalah sistem monitoring deteksi dini kebocoran gas LPG dan api pada lingkungan dapur berbasis mikrokontroler ESP32 dengan Firebase cloud storage.</p>
          
          <h3>üéØ Latar Belakang</h3>
          <p>1. Kebocoran gas LPG adalah penyebab umum kebakaran rumah tangga yang sering tidak terdeteksi hingga terlambat karena deteksi manual tidak efektif 24/7, terutama saat tidur atau rumah kosong.</p>
          
          <p>2. Sistem alarm tradisional hanya berfungsi lokal dan tidak dapat memberi tahu pemilik rumah yang sedang berada di luar, sehingga tindakan pencegahan tidak dapat dilakukan secara cepat.</p>
          
          <p>3. Teknologi IoT memungkinkan sistem deteksi pintar dengan notifikasi instant ke smartphone, memberikan perlindungan 24/7 yang lebih efektif dan mudah diakses untuk rumah tangga modern.</p>
          
          <h3>‚öôÔ∏è Komponen Sistem</h3>
          <div class="components-grid">
            <div class="component-box">
              <h4>ESP32</h4>
              <p>Mikrokontroler utama dengan WiFi untuk IoT</p>
            </div>
            <div class="component-box">
              <h4>AMG8833</h4>
              <p>Deteksi sumber panas dan api dengan thermal imaging 8x8 pixel</p>
            </div>
            <div class="component-box">
              <h4>MQ-6</h4>
              <p>Deteksi kebocoran gas LPG secara real-time</p>
            </div>
            <div class="component-box">
              <h4>OLED Display</h4>
              <p>Tampilan visual status sistem dan data sensor</p>
            </div>
            <div class="component-box">
              <h4>Passive Buzzer</h4>
              <p>Alarm audio untuk peringatan lokal multi-level</p>
            </div>
          </div>
          
          <h3>‚ú® Fitur Utama</h3>
          <p>‚Ä¢ <strong>Real-time monitoring</strong>: Pemantauan suhu dan gas secara kontinyu<br>
          ‚Ä¢ <strong>Thermal heatmap</strong>: Visualisasi distribusi panas 8x8 pixels<br>
          ‚Ä¢ <strong>Firebase cloud storage</strong>: Data tersimpan permanen di cloud<br>
          ‚Ä¢ <strong>Remote monitoring</strong>: Dashboard bisa diakses dari mana saja<br>
          ‚Ä¢ <strong>Telegram notification</strong>: Notifikasi instant ke smartphone<br>
          ‚Ä¢ <strong>Visual & audio alarm</strong>: Peringatan melalui buzzer dan indikator visual</p>
          
          <h3>üë• Tim Pengembang</h3>
          <p>Kelompok 9 - Teknik Elektro, Universitas Indonesia<br>
          ‚Ä¢ Gracia Ronauli Arella (2206062762)<br>
          ‚Ä¢ Annysa Hana Naadhirah Gumay (2206062781)<br>
          ‚Ä¢ Saffana Hadaina Sadida (2206062554)<br>
          ‚Ä¢ Andra Rizky Ramadhan (2206829244)</p>
        </div>
      </div>
    </div>
    
    <!-- Tutorial Page -->
    <div id="tutorial" class="page">
      <button class="back-btn" onclick="showPage('landing')">‚Üê Back to Menu</button>
      <h1 class="page-title">Tutorial Alat FIGS</h1>
      
      <div class="card">
        <h2>üéì Cara Menggunakan FIGS</h2>
        <div class="about-content">
          <div class="tutorial-step">
            <h3>Step 1: Persiapan Alat</h3>
            <p>Pastikan semua komponen terpasang dengan benar sesuai wiring diagram. Hubungkan ESP32 ke power supply 5V dan tunggu hingga sistem boot.</p>
          </div>
          
          <div class="tutorial-step">
            <h3>Step 2: Koneksi WiFi</h3>
            <p>ESP32 akan otomatis connect ke WiFi yang sudah dikonfigurasi. OLED display akan menampilkan status koneksi dan mulai streaming data ke Firebase.</p>
          </div>
          
          <div class="tutorial-step">
            <h3>Step 3: Warming Up Sensor</h3>
            <p>Sensor MQ-6 membutuhkan warming up selama 30 detik. Selama proses ini, jangan test dengan gas. OLED akan menampilkan countdown warming up.</p>
          </div>
          
          <div class="tutorial-step">
            <h3>Step 4: Monitoring Real-Time</h3>
            <p>Setelah warming up selesai, sistem akan mulai monitoring:<br><br>
            ‚Ä¢ <strong>Status Normal</strong>: Data streaming ke Firebase, buzzer off<br>
            ‚Ä¢ <strong>Gas Detected</strong>: Buzzer berbunyi, notifikasi Telegram terkirim<br>
            ‚Ä¢ <strong>Fire Detected</strong>: Buzzer bunyi terus-menerus, alert maksimal</p>
          </div>
          
          <div class="tutorial-step">
            <h3>Step 5: Akses Dashboard</h3>
            <p>Buka website dashboard (GitHub Pages) untuk melihat data real-time:<br>
            ‚Ä¢ Thermal heatmap 8x8 pixel dari sensor AMG8833<br>
            ‚Ä¢ Status gas detection dari sensor MQ-6<br>
            ‚Ä¢ History log fire & gas events<br>
            ‚Ä¢ Grafik monitoring temperature trends<br>
            ‚Ä¢ Bisa diakses dari device apapun (laptop, HP, tablet)</p>
          </div>
          
          <div class="tutorial-step">
            <h3>Step 6: Notifikasi Telegram</h3>
            <p>Jika bahaya terdeteksi, sistem akan mengirim notifikasi ke Telegram dengan informasi detail status sensor dan instruksi keamanan darurat.</p>
          </div>
          
          <div class="tutorial-step">
            <h3>üí° Tips Keamanan</h3>
            <p>‚Ä¢ Letakkan alat di area strategis dekat kompor gas<br>
            ‚Ä¢ Jangan halangi sensor dengan benda lain<br>
            ‚Ä¢ Test sistem secara berkala dengan lighter (jarak aman 20-30cm)<br>
            ‚Ä¢ Pastikan buzzer terdengar jelas dari seluruh ruangan<br>
            ‚Ä¢ Simpan nomor darurat pemadam kebakaran (113/112)</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Dashboard Page -->
    <div id="dashboard" class="page">
      <button class="back-btn" onclick="showPage('landing')">‚Üê Back to Menu</button>
      <h1 class="page-title">Dashboard FIGS - Live Data</h1>
      
      <div class="dashboard-grid">
        <!-- Thermal Heatmap -->
        <div class="card">
          <h2>üå°Ô∏è Thermal Heatmap (AMG8833)</h2>
          <div class="heatmap-container">
            <div id="grid"></div>
            <div class="legend">
              <div class="legend-item">
                <div class="legend-color" style="background: rgb(0,0,255)"></div>
                <span>20¬∞C</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: rgb(0,255,255)"></div>
                <span>25¬∞C</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: rgb(0,255,0)"></div>
                <span>30¬∞C</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: rgb(255,255,0)"></div>
                <span>35¬∞C</span>
              </div>
              <div class="legend-item">
                <div class="legend-color" style="background: rgb(255,0,0)"></div>
                <span>40¬∞C+</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Status Panel -->
        <div class="card">
          <h2>üìä System Status</h2>
          <div class="status-panel">
            <div class="status-item" id="tempStatus">
              <div class="status-label">Temperature Status</div>
              <div class="status-value" id="tempValue">Loading...</div>
            </div>
            <div class="status-item" id="gasStatus">
              <div class="status-label">Gas Detection (MQ-6)</div>
              <div class="status-value" id="gasValue">Loading...</div>
            </div>
            <div class="status-item" id="uptimeStatus">
              <div class="status-label">System Uptime</div>
              <div class="status-value" id="uptimeValue">--</div>
            </div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-value" id="totalFireEvents">0</div>
              <div class="stat-label">Fire Events</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="totalGasEvents">0</div>
              <div class="stat-label">Gas Events</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Fire History -->
      <div class="card">
        <h2>üî• Fire Detection History</h2>
        <div class="table-container">
          <table id="fireTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Timestamp</th>
                <th>Max Temp (¬∞C)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="4" style="text-align: center; opacity: 0.6;">No events yet</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="chart-container">
          <canvas id="fireChart"></canvas>
        </div>
      </div>
      
      <!-- Gas History -->
      <div class="card">
        <h2>‚ö†Ô∏è Gas Detection History</h2>
        <div class="table-container">
          <table id="gasTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Timestamp</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3" style="text-align: center; opacity: 0.6;">No events yet</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="chart-container">
          <canvas id="gasChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <script>
    // ==================== FIREBASE CONFIG ====================
    const FIREBASE_URL = 'https://figs-despro-default-rtdb.firebaseio.com';
    
    // ==================== STATE ====================
    let fireChart, gasChart;
    let lastFireWarning = false;
    let lastGasWarning = false;
    
    const fireChartData = { labels: [], temps: [] };
    const gasChartData = { labels: [], detections: [] };
    
    // ==================== PAGE NAVIGATION ====================
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      if (pageId === 'dashboard' && !window.dashboardStarted) {
        initDashboard();
        window.dashboardStarted = true;
      }
    }
    
    // ==================== FIREBASE FETCH ====================
    async function fetchFirebase(path) {
      try {
        const res = await fetch(`${FIREBASE_URL}${path}.json`);
        if (!res.ok) throw new Error('Fetch failed');
        return await res.json();
      } catch (err) {
        console.error('Firebase error:', err);
        return null;
      }
    }
    
    function formatTime(seconds) {
      const date = new Date(seconds * 1000);
      return date.toLocaleString('id-ID', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
    
    function formatUptime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${h}h ${m}m ${s}s`;
    }
    
    // ==================== THERMAL HEATMAP ====================
    function tempToColor(t) {
      const tMin = 20.0;
      const tMax = 40.0;
      let v = (t - tMin) / (tMax - tMin);
      if (v < 0) v = 0;
      if (v > 1) v = 1;
      
      let r, g, b;
      if (v < 0.25) {
        v /= 0.25;
        r = 0; g = v * 255; b = 255;
      } else if (v < 0.5) {
        v = (v - 0.25) / 0.25;
        r = 0; g = 255; b = 255 - v * 255;
      } else if (v < 0.75) {
        v = (v - 0.5) / 0.25;
        r = v * 255; g = 255; b = 0;
      } else {
        v = (v - 0.75) / 0.25;
        r = 255; g = 255 - v * 255; b = 0;
      }
      return `rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`;
    }
    
    function initHeatmap() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      for (let i = 0; i < 64; i++) {
        const div = document.createElement('div');
        div.className = 'cell';
        grid.appendChild(div);
      }
    }
    
    async function updateHeatmap() {
      const thermal = await fetchFirebase('/sensors/thermal');
      if (!thermal) return;
      
      const cells = document.getElementsByClassName('cell');
      for (let i = 0; i < 64; i++) {
        const temp = thermal[i] || 25;
        cells[i].style.backgroundColor = tempToColor(temp);
      }
    }
    
    // ==================== UPDATE STATUS ====================
    async function updateStatus() {
      const sensors = await fetchFirebase('/sensors/current');
      const status = await fetchFirebase('/status');
      
      if (!sensors || !status) {
        document.getElementById('connectionStatus').className = 'connection-status error';
        document.getElementById('connectionStatus').textContent = '‚ùå Connection Error';
        return;
      }
      
      document.getElementById('connectionStatus').className = 'connection-status connected';
      document.getElementById('connectionStatus').textContent = '‚úÖ Live Data';
      
      // Temperature
      const tempStatus = document.getElementById('tempStatus');
      const tempValue = document.getElementById('tempValue');
      if (status.fireWarning) {
        tempStatus.className = 'status-item warning';
        tempValue.textContent = `üî• ${sensors.maxTemp}¬∞C - FIRE WARNING!`;
        tempValue.style.color = '#ff6b6b';
      } else {
        tempStatus.className = 'status-item safe';
        tempValue.textContent = `Min: ${sensors.minTemp}¬∞C | Max: ${sensors.maxTemp}¬∞C`;
        tempValue.style.color = '#51cf66';
      }
      
      // Gas
      const gasStatus = document.getElementById('gasStatus');
      const gasValue = document.getElementById('gasValue');
      if (sensors.warmupRemain > 0) {
        gasStatus.className = 'status-item';
        gasValue.textContent = `‚è≥ Calibrating... ${sensors.warmupRemain}s`;
        gasValue.style.color = '#4ecdc4';
      } else if (status.gasWarning) {
        gasStatus.className = 'status-item warning';
        gasValue.textContent = '‚ö†Ô∏è GAS DETECTED';
        gasValue.style.color = '#ffb86c';
      } else {
        gasStatus.className = 'status-item safe';
        gasValue.textContent = '‚úì No Gas Detected';
        gasValue.style.color = '#51cf66';
      }
      
      // Stats
      document.getElementById('uptimeValue').textContent = formatUptime(status.uptime);
      document.getElementById('totalFireEvents').textContent = status.fireEventCount || 0;
      document.getElementById('totalGasEvents').textContent = status.gasEventCount || 0;
      
      // Charts
      if (status.fireWarning && !lastFireWarning) {
        updateFireChart(sensors.maxTemp);
      }
      if (status.gasWarning && !lastGasWarning) {
        updateGasChart();
      }
      
      lastFireWarning = status.fireWarning;
      lastGasWarning = status.gasWarning;
    }
    
    // ==================== HISTORY ====================
    async function updateFireHistory() {
      const events = await fetchFirebase('/events/fire');
      if (!events) return;
      
      const tbody = document.querySelector('#fireTable tbody');
      tbody.innerHTML = '';
      
      const arr = Object.values(events).reverse().slice(0, 50);
      if (arr.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; opacity: 0.6;">No events yet</td></tr>';
        return;
      }
      
      arr.forEach(e => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.eventId}</td>
          <td>${formatTime(e.timestamp)}</td>
          <td style="color: #ff6b6b; font-weight: bold;">${e.maxTemp.toFixed(1)}¬∞C</td>
          <td><span style="color: #ff6b6b;">‚ö†Ô∏è Fire Detected</span></td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    async function updateGasHistory() {
      const events = await fetchFirebase('/events/gas');
      if (!events) return;
      
      const tbody = document.querySelector('#gasTable tbody');
      tbody.innerHTML = '';
      
      const arr = Object.values(events).reverse().slice(0, 50);
      if (arr.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; opacity: 0.6;">No events yet</td></tr>';
        return;
      }
      
      arr.forEach(e => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.eventId}</td>
          <td>${formatTime(e.timestamp)}</td>
          <td><span style="color: #ffb86c;">‚ö†Ô∏è Gas Detected</span></td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // ==================== CHARTS ====================
    function initCharts() {
      const fireCtx = document.getElementById('fireChart').getContext('2d');
      const gasCtx = document.getElementById('gasChart').getContext('2d');
      
      fireChart = new Chart(fireCtx, {
        type: 'line',
        data: {
          labels: fireChartData.labels,
          datasets: [{
            label: 'Max Temperature (¬∞C)',
            data: fireChartData.temps,
            borderColor: '#ff6b6b',
            backgroundColor: 'rgba(255, 107, 107, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#eee', font: { size: 14 } } } },
          scales: {
            y: { ticks: { color: '#eee' }, grid: { color: 'rgba(255,255,255,0.1)' } },
            x: { ticks: { color: '#eee' }, grid: { color: 'rgba(255,255,255,0.1)' } }
          }
        }
      });
      
      gasChart = new Chart(gasCtx, {
        type: 'bar',
        data: {
          labels: gasChartData.labels,
          datasets: [{
            label: 'Gas Detections',
            data: gasChartData.detections,
            backgroundColor: 'rgba(255, 184, 108, 0.6)',
            borderColor: '#ffb86c',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#eee', font: { size: 14 } } } },
          scales: {
            y: { ticks: { color: '#eee', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.1)' } },
            x: { ticks: { color: '#eee' }, grid: { color: 'rgba(255,255,255,0.1)' } }
          }
        }
      });
    }
    
    function updateFireChart(temp) {
      const now = new Date().toLocaleTimeString();
      fireChartData.labels.push(now);
      fireChartData.temps.push(temp);
      if (fireChartData.labels.length > 20) {
        fireChartData.labels.shift();
        fireChartData.temps.shift();
      }
      if (fireChart) fireChart.update();
    }
    
    function updateGasChart() {
      const now = new Date().toLocaleTimeString();
      gasChartData.labels.push(now);
      gasChartData.detections.push(1);
      if (gasChartData.labels.length > 20) {
        gasChartData.labels.shift();
        gasChartData.detections.shift();
      }
      if (gasChart) gasChart.update();
    }
    
    // ==================== DASHBOARD INIT ====================
    function initDashboard() {
      initHeatmap();
      initCharts();
      mainLoop();
      setInterval(mainLoop, 2000);
    }
    
    async function mainLoop() {
      await updateHeatmap();
      await updateStatus();
      await updateFireHistory();
      await updateGasHistory();
    }
    
    console.log('üî• FIGS Dashboard Ready');
    console.log('üì° Firebase:', FIREBASE_URL);
  </script>
</body>
</html>
